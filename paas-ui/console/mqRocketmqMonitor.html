<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <title>MQ_ROCKETMQ监控</title>

	<link href="../css/thirdParty/bootstrap-datetimepicker.min.css" type="text/css" rel="stylesheet" />

	<style>
		.input-append .add-on,
		.input-prepend .add-on {
			background-color: #e17a1f;
			/* !important; */
		}
		.add-on>i{
			color:white;
		}
		.table-head{padding-right:17px;background-color: rgba(153, 153, 153, 0.42);color:#000;}
		.table-body{width:100%; height:215px;overflow-y:auto;}
		.table-head table,.table-body table{width:100%;}
		/*.table-body table tr:nth-child(2n+1){background-color:#f2f2f2;}*/
	</style>

</head>

<body id="body">
	<div class="row bg-light">
		<div class="col-lg-12 col-sm-12 breadcrumb bg-light">
			<li class="breadcrumb-item">基础服务功能</li>
			<li class="breadcrumb-item"><a data-load-page="serviceList" href="#">服务集群管理</a></li>
			<li class="breadcrumb-item"><span id="servName"></span><span>监控</span></li>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12">
			<div class="form-inline mt-md-0 mr-2 pt-1 float-right" >
				<div class="input-group">
					<select class="custom-select custom-select-icon" id="S_SERV_CLAZZ">
						<option selected value = "300000">Last 5 Minites</option>
						<option value ="600000 ">Last 10 Minites</option>
						<option value ="1200000">Last 20 Minites</option>
						<option value ="1800000">Last 30 Minites</option>
                        <option value ="3600000">Last 1 Hour</option>
                        <option value ="10800000">Last 3 Hour</option>
                        <option value ="21600000">Last 6 Hour</option>
                        <option value ="43200000">Last 12 Hour</option>
                        <option value ="86400000">Last 24 Hour</option>
                        <option value ="604800000">Last 7 Days</option>
                        <option value ="1209600000">Last 14 Days</option>
					</select>
				</div>
				<div class="ml-3">
					<button class="btn btn-outline-success" onclick="searchService();"><i class="iconfont ibsp-chaxun mr-1"></i>搜索</button>
				</div>
			</div>
			<div class="btn-group float-left mr-0" style="width: 1300px;">                    
                <label class="mt-2">实例ID：</label>
                <div class="col-sm-4">
					<select class="custom-select" id="MQ_ROCKETMQ_SELECT_INST_ID" onchange="getTopicName()">
					</select>
				</div>
                <label class="mt-2">主题名称：</label>
                <div class="col-sm-3">
					<select class="custom-select" id="MQ_ROCKETMQ_SELECT_TOPIC_NAME" onchange="getConsumeGroup()">
                        <option value = "">所有</option>
					</select>
				</div>
                <label class="mt-2">消费组：</label>
                <div class="col-sm-3">
					<select class="custom-select" id="MQ_ROCKETMQ_SELECT_CONSUME_GROUP" onchange="searchService();">
                        <option value = "">所有</option>
					</select>
				</div>
                <!-- <div class="col-sm-3">
                    <label class="mt-2">开始时间：</label>
                    <div class="date input-append form_datetime pull-right" data-date="" data-date-format="yyyy-mm-dd HH:ii:ss" data-link-field="from_date" style="width: 200px;">
                        <input id="from_date" class="form-control calendar-input" type="text" value="" >
                        <span class="add-on"><i class="icon-th iconfont"></i></span>
                    </div>
                </div>
				<div class="col-sm-3">
                    <label class="ml-3 mt-2">结束时间：</label>
                    <div class="input-append date form_datetime pull-right " data-date="" data-date-format="yyyy-mm-dd HH:ii:ss" data-link-field="to_date" style="width: 200px;">
                        <input id="to_date" class="form-control calendar-input" type="text" value="" >
                        <span class="add-on"><i class="icon-th iconfont"></i></span>
                    </div>
                </div> -->
				
			</div>
		</div>
	</div>
	<div id="mq_rocketmq_main" style="width: 100%; height:600px;"></div>
</body>

<script src="../js/thirdParty/echarts.min.js" type="text/javascript" ></script>
<script src="../js/thirdParty/bootstrap-datetimepicker.min.js" type="text/javascript" charset="UTF-8"></script>
<script src="../js/thirdParty/bootstrap-datetimepicker.zh-CN.js" type="text/javascript" charset="UTF-8"></script>

<script src="../js/mqRocketmqMonitor.js" type="text/javascript"></script>

<script type="text/javascript" >
    //  from_date = $("#from_date"),
    //     to_date    = $("#to_date"),
    // var $servInterval = $("#S_SERV_CLAZZ");
    // searchMonitorButton = $("#searchMonitorButton");
    // now = new Date(),
    //     preN = new Date(now.getTime() - 3600*1000),
    //     mm = undefined,
    //     serviceId = undefined;
    var mm, date = new Date().getTime(), startTime, mmTimer, SERV_INST_ID;

    function initInstId(servId) {
        SERV_INST_ID = servId;

        var data = {};
        data.SERV_INST_ID = SERV_INST_ID;
        $.ajax({
            url: Url.monitorList.getRocketMQServBrokers,
            async: false,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(data),
            success: function (result) {
                if (result.RET_CODE == 0) {
                    var select = $("#MQ_ROCKETMQ_SELECT_INST_ID");
                    var selectList = "<option selected value = ''>所有</option>";
                    if(result.RET_INFO.length >0){
                        for(var i = 0; i < result.RET_INFO.length; i++){
                            var instData = result.RET_INFO[i];
                            selectList+="<option value="+ instData.INST_ID +">"+ instData.BROKER_NAME +"</option>";
                        }
                    }
                    select.html(selectList);
                }
            },
            error: function (error) {
                Util.alert("error", error);
            }
        });

        mm = new MqRocketmqMonitor({"INST_ID": $("#MQ_ROCKETMQ_SELECT_INST_ID").val(), "TIME_INTERVAL": $("#S_SERV_CLAZZ").val(),"SERV_INST_ID": SERV_INST_ID
    ,"TOPIC_NAME": $("#MQ_ROCKETMQ_SELECT_TOPIC_NAME").val(), "CONSUME_GROUP": $("#MQ_ROCKETMQ_SELECT_CONSUME_GROUP").val()});
        if(null == mmTimer){
            mmTimer = window.setInterval(function(){
                mm.init();
            }, 10000);
        }
	}

    function searchService () {
        mm = new MqRocketmqMonitor({"INST_ID": $("#MQ_ROCKETMQ_SELECT_INST_ID").val(), "TIME_INTERVAL": $("#S_SERV_CLAZZ").val(),"SERV_INST_ID": SERV_INST_ID
    ,"TOPIC_NAME": $("#MQ_ROCKETMQ_SELECT_TOPIC_NAME").val(), "CONSUME_GROUP": $("#MQ_ROCKETMQ_SELECT_CONSUME_GROUP").val()});
	}
    
    $(".breadcrumb>li>a").off("click").on("click",function(){
        window.clearInterval(mmTimer);
        mmTimer = null;
        var $this = $(this);
        pageName = $this.data("load-page");
        $(".contextMenu").remove();
        if(pageName != ""){
            $mainContainer.load(pageName+".html",function(){
                initPage();
            });
        }
    });

    function getTopicName () {
        var data = {},instId = $("#MQ_ROCKETMQ_SELECT_INST_ID").val();
        if("" != instId){
            data.INST_ID = instId;
            $.ajax({
                url: Url.monitorList.getTopicNameByInstId,
                async: false,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(data),
                success: function (result) {
                    if (result.RET_CODE == 0) {
                        var select = $("#MQ_ROCKETMQ_SELECT_TOPIC_NAME");
                        var selectList = "<option selected value = ''>所有</option>";
                        if(result.RET_INFO.length >0){
                            for(var i = 0; i < result.RET_INFO.length; i++){
                                var instData = result.RET_INFO[i];
                                selectList+="<option value="+ instData +">"+ instData +"</option>";
                            }
                        }
                        select.html(selectList);
                    }
                    getConsumeGroup();
                },
                error: function (error) {
                    Util.alert("error", error);
                }
            });
        }else{
            var select = $("#MQ_ROCKETMQ_SELECT_TOPIC_NAME");
            var selectList = "<option selected value = ''>所有</option>";
            select.html(selectList);
            getConsumeGroup();
        }
    }

    function getConsumeGroup () {
        var data = {},topicName = $("#MQ_ROCKETMQ_SELECT_TOPIC_NAME").val();
        if("" != topicName){
            data.TOPIC_NAME = topicName;
            $.ajax({
                url: Url.monitorList.getConsumeGroupByTopicName,
                async: false,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(data),
                success: function (result) {
                    if (result.RET_CODE == 0) {
                        var select = $("#MQ_ROCKETMQ_SELECT_CONSUME_GROUP");
                        var selectList = "<option selected value = ''>所有</option>";
                        if(result.RET_INFO.length >0){
                            for(var i = 0; i < result.RET_INFO.length; i++){
                                var instData = result.RET_INFO[i];
                                selectList+="<option value="+ instData +">"+ instData +"</option>";
                            }
                        }
                        select.html(selectList);
                    }
                },
                error: function (error) {
                    Util.alert("error", error);
                }
            });
        }else{
            var select = $("#MQ_ROCKETMQ_SELECT_CONSUME_GROUP");
            var selectList = "<option selected value = ''>所有</option>";
            select.html(selectList);
        }
        searchService();
    }

    // $('.form_datetime').datetimepicker({
    //     language:  'zh-CN',
    //     weekStart: 1,
    //     todayBtn:  1,
    //     autoclose: 1,
    //     todayHighlight: 1,
    //     startView: 2,
    //     minView: 2,
    //     forceParse: 0
    // });

    // setDataInput(3600);

    // $servInterval.bind("change", function () {
	// 	var interval = $(this).val();
    //     setDataInput(interval);
    // });

    // function setDataInput(interval) {
    //     now = new Date();
    //     preN = new Date(now.getTime() - interval*1000);
	// 	var nowStr = now.simpleFormat("yyyy-MM-dd hh:mm:ss"),
    //         prevStr = preN.simpleFormat("yyyy-MM-dd hh:mm:ss");
    //     from_date.val(prevStr);
    //     to_date.val(nowStr);
    // }
	
	

    

</script>
</html>
